/*
    jsInst
    @copyright 2013  Zheng Li <lizheng@lizheng.me>
    @github https://github.com/nocoo/jsinst
    @license MIT
*/
var jsinst;(function(k){var l={'enabled':true,'classname':'jsinst','feature':'data-feature','value':'data-value','max_queue':3,'method':'get','endpoint':'/','data':'data'};var m,track_list,event_queue,callback_queue,callback_send;var n={'feature':'f','data':'d','timestamp':'ts'};var o=function(a,b,c){if(a.addEventListener){a.addEventListener(b,c,false)}else if(a.attachEvent){a.attachEvent('on'+b,c)}else{a['on'+b]=c}};var p=function(a,b,c){if(a.removeEventListener){a.removeEventListener(b,c,false)}else if(a.detachEvent){a.detachEvent('on'+b,c)}else{a['on'+b]=null}};k.reset=function(){delete track_list;delete event_queue;delete callback_queue;delete callback_send;track_list={};event_queue=[];callback_queue=[];callback_send=[];if(l.enabled){var e=function(a){var b=a.target.getAttribute('data-feature')||'uknown';var c=a.target.getAttribute('data-value')||'undefined';var d={};d.feature=b;d.data=c;k.queue(d)};var f=document.getElementsByClassName(l.classname);for(var i=0,len=f.length;i<len;++i){var g=f[i];p(g,'click',e);o(g,'click',e,true)}var h=function(a){if(l.method.toLowerCase()==='image'){m=document.createElement('img');m.setAttribute('style','width:0;height:0;display:none;');var b=document.getElementsByTagName('body');if(b&&b.length===1){b[0].appendChild(m)}}};var j=function(a){k.send(k.serialize(),false);event_queue=[]};o(window,'load',h);o(window,'beforeunload',j)}};k.queue=function(a){if(!l.enabled){return}if(!a.timestamp){a.timestamp=(new Date()).getTime()}event_queue.push(a);if(event_queue.length>=l.max_queue){k.send(k.serialize(),true);event_queue=[]}var b;for(var i=0,len=callback_queue.length;i<len;++i){b=callback_queue[i];if(b.callback&&typeof(b.callback)==='function'){b.callback.apply(b.that,[a])}}};k.send=function(a,b){if(!l.enabled){return}if(a=='[]'){return}var c=new XMLHttpRequest();var d=l.endpoint+'?'+l.data+'='+encodeURIComponent(a)+'&'+k.timestamp();switch(l.method.toLowerCase()){case'image':default:{if(m){m.setAttribute('src',d)}break}case'head':{if(c){c.open('HEAD',d,b);c.send(null)}break}case'get':{if(c){c.open('GET',d,b);c.send(null)}break}case'post':{if(c){c.open('POST',l.endpoint,b);c.send(encodeURIComponent(l.data)+'='+encodeURIComponent(a))}break}}var e;for(var i=0,len=callback_send.length;i<len;++i){e=callback_send[i];if(e.callback&&typeof(e.callback)==='function'){e.callback.apply(e.that,[a])}}};k.start=function(a){a=a||'default';track_list[a]=k.timestamp()};k.end=function(a){var b=k.timestamp();a=a||'default';if(!track_list[a]){return 0}else{var c=b-track_list[a];delete track_list[a];return c}};k.info=function(){console.log(l);console.log(track_list);console.log(event_queue)};k.register=function(a,b,c){switch(a){case'queue':{callback_queue.push({'callback':b,'that':c});break}case'send':{callback_send.push({'callback':b,'that':c});break}}};k.serialize=function(){var a=[],item;a.push('[');for(var i=0,len=event_queue.length;i<len;++i){item=event_queue[i];a.push('{"'+n.feature+'":"'+item.feature+'",');a.push('"'+n.data+'":"'+item.data+'",');a.push('"'+n.timestamp+'":'+item.timestamp+'}');if(i<len-1){a.push(',')}}a.push(']');return a.join('')};k.timestamp=function(){return(new Date).getTime()};k.reset()})(jsinst||(jsinst={}));
